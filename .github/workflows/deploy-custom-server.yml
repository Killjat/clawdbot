name: Deploy to Custom Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'Server name (for identification)'
        required: true
        default: 'production-server'
        type: string
      deployment_method:
        description: 'Deployment method'
        required: true
        default: 'docker'
        type: choice
        options:
          - docker
          - docker-compose
          - direct-install
          - pm2
      restart_services:
        description: 'Restart services after deployment'
        required: false
        default: true
        type: boolean

  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.23.0 --activate

      - name: Install and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version tag
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="custom-$(date +%Y%m%d-%H%M%S)"
          else
            VERSION="main-$(git rev-parse --short HEAD)"
          fi
          # Convert repository name to lowercase for Docker registry
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "image-tag=${{ env.REGISTRY }}/$IMAGE_NAME_LOWER:$VERSION" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          tags: ${{ steps.version.outputs.image-tag }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy via Docker
        if: github.event.inputs.deployment_method == 'docker' || github.event.inputs.deployment_method == ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹ Docker éƒ¨ç½²åˆ° ${{ github.event.inputs.server_name || 'production-server' }}"
            
            # è®¾ç½®é”™è¯¯å¤„ç†
            set -euo pipefail
            
            # ç™»å½•åˆ° GitHub Container Registry
            echo "ç™»å½•åˆ° GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            echo "åœæ­¢ç°æœ‰å®¹å™¨..."
            docker stop moltbot || true
            docker rm moltbot || true
            
            # æ¸…ç†æ—§é•œåƒ
            echo "æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f || true
            
            # æ‹‰å–æ–°é•œåƒ
            echo "æ‹‰å–æ–°é•œåƒ: ${{ steps.version.outputs.image-tag }}"
            docker pull ${{ steps.version.outputs.image-tag }}
            
            # åˆ›å»ºæ•°æ®ç›®å½•
            echo "åˆ›å»ºæ•°æ®ç›®å½•..."
            mkdir -p ~/moltbot-data/.clawdbot
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name moltbot \
              --restart unless-stopped \
              -p 18789:18789 \
              -v ~/moltbot-data:/home/node/.clawdbot \
              -e NODE_ENV=production \
              -e CLAWDBOT_GATEWAY_TOKEN="${{ secrets.PRODUCTION_GATEWAY_TOKEN }}" \
              -e DEEPSEEK_API_KEY="${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}" \
              -e CLAWDBOT_VERSION="${{ steps.version.outputs.version }}" \
              ${{ steps.version.outputs.image-tag }}
            
            # ç­‰å¾…å¯åŠ¨
            echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker ps | grep moltbot
            
            # æ£€æŸ¥å®¹å™¨æ—¥å¿—
            echo "å®¹å™¨å¯åŠ¨æ—¥å¿—ï¼š"
            docker logs moltbot --tail 20
            
            # å¥åº·æ£€æŸ¥
            echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..5}; do
              if curl -f http://localhost:18789/health; then
                echo "âœ… éƒ¨ç½²æˆåŠŸï¼å¥åº·æ£€æŸ¥é€šè¿‡"
                echo "è®¿é—®åœ°å€: http://$(curl -s ifconfig.me):18789"
                exit 0
              else
                echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5..."
                sleep 5
              fi
            done
            
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
            docker logs moltbot --tail 50
            exit 1

      - name: Deploy via Docker Compose
        if: github.event.inputs.deployment_method == 'docker-compose'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹ Docker Compose éƒ¨ç½²"
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p ~/moltbot-deploy
            cd ~/moltbot-deploy
            
            # åˆ›å»º docker-compose.yml
            cat > docker-compose.yml << 'EOF'
            version: '3.8'
            services:
              moltbot:
                image: ${{ steps.version.outputs.image-tag }}
                container_name: moltbot
                restart: unless-stopped
                ports:
                  - "18789:18789"
                volumes:
                  - ./data:/home/node/.clawdbot
                environment:
                  - NODE_ENV=production
                  - CLAWDBOT_GATEWAY_TOKEN=${{ secrets.PRODUCTION_GATEWAY_TOKEN }}
                  - DEEPSEEK_API_KEY=${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}
                  - CLAWDBOT_VERSION=${{ steps.version.outputs.version }}
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
            EOF
            
            # ç™»å½•å¹¶éƒ¨ç½²
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            docker-compose pull
            docker-compose up -d
            
            # ç­‰å¾…å¥åº·æ£€æŸ¥
            sleep 30
            if docker-compose ps | grep -q "healthy\|Up"; then
              echo "âœ… Docker Compose éƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ éƒ¨ç½²å¤±è´¥"
              docker-compose logs
              exit 1
            fi

      - name: Deploy via Direct Install
        if: github.event.inputs.deployment_method == 'direct-install'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹ç›´æ¥å®‰è£…éƒ¨ç½²"
            
            # å®‰è£… Node.js 22 (å¦‚æœæœªå®‰è£…)
            if ! node --version | grep -q "v22"; then
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # å…‹éš†æˆ–æ›´æ–°ä»£ç 
            if [ -d "moltbot" ]; then
              cd moltbot
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git moltbot
              cd moltbot
            fi
            
            # å®‰è£…ä¾èµ–å’Œæ„å»º
            corepack enable
            corepack prepare pnpm@10.23.0 --activate
            pnpm install --frozen-lockfile
            pnpm build
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            cat > .env.production << EOF
            NODE_ENV=production
            CLAWDBOT_GATEWAY_TOKEN=${{ secrets.PRODUCTION_GATEWAY_TOKEN }}
            DEEPSEEK_API_KEY=${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}
            CLAWDBOT_VERSION=${{ steps.version.outputs.version }}
            EOF
            
            # åœæ­¢ç°æœ‰è¿›ç¨‹
            pkill -f "moltbot gateway" || true
            
            # å¯åŠ¨æ–°è¿›ç¨‹
            nohup node dist/index.js gateway run --bind lan --port 18789 > ~/moltbot.log 2>&1 &
            
            # ç­‰å¾…å¯åŠ¨
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:18789/health; then
              echo "âœ… ç›´æ¥å®‰è£…éƒ¨ç½²æˆåŠŸï¼"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              tail -50 ~/moltbot.log
              exit 1
            fi

      - name: Deploy via PM2
        if: github.event.inputs.deployment_method == 'pm2'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹ PM2 éƒ¨ç½²"
            
            # å®‰è£… PM2 (å¦‚æœæœªå®‰è£…)
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            # å…‹éš†æˆ–æ›´æ–°ä»£ç 
            if [ -d "moltbot" ]; then
              cd moltbot
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/${{ github.repository }}.git moltbot
              cd moltbot
            fi
            
            # å®‰è£…ä¾èµ–å’Œæ„å»º
            corepack enable
            corepack prepare pnpm@10.23.0 --activate
            pnpm install --frozen-lockfile
            pnpm build
            
            # åˆ›å»º PM2 é…ç½®
            cat > ecosystem.config.js << 'EOF'
            module.exports = {
              apps: [{
                name: 'moltbot',
                script: 'dist/index.js',
                args: 'gateway run --bind lan --port 18789',
                env: {
                  NODE_ENV: 'production',
                  CLAWDBOT_GATEWAY_TOKEN: '${{ secrets.PRODUCTION_GATEWAY_TOKEN }}',
                  DEEPSEEK_API_KEY: '${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}',
                  CLAWDBOT_VERSION: '${{ steps.version.outputs.version }}'
                },
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                log_file: '~/moltbot-combined.log',
                out_file: '~/moltbot-out.log',
                error_file: '~/moltbot-error.log'
              }]
            };
            EOF
            
            # é‡å¯ PM2 åº”ç”¨
            pm2 reload ecosystem.config.js
            pm2 save
            
            # ç­‰å¾…å¯åŠ¨
            sleep 10
            
            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:18789/health; then
              echo "âœ… PM2 éƒ¨ç½²æˆåŠŸï¼"
              pm2 status
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              pm2 logs moltbot --lines 50
              exit 1
            fi

      - name: Setup Nginx (optional)
        if: github.event.inputs.restart_services == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # æ£€æŸ¥æ˜¯å¦éœ€è¦é…ç½® Nginx
            if command -v nginx &> /dev/null && [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
              echo "ğŸ”§ é…ç½® Nginx åå‘ä»£ç†"
              
              sudo tee /etc/nginx/sites-available/moltbot << 'EOF'
            server {
                listen 80;
                server_name ${{ secrets.DOMAIN_NAME }};
                
                location / {
                    proxy_pass http://localhost:18789;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_cache_bypass $http_upgrade;
                }
            }
            EOF
              
              sudo ln -sf /etc/nginx/sites-available/moltbot /etc/nginx/sites-enabled/
              sudo nginx -t && sudo systemctl reload nginx
              
              echo "âœ… Nginx é…ç½®å®Œæˆ"
            fi

      - name: Deployment Summary
        run: |
          echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æœåŠ¡å™¨**: ${{ github.event.inputs.server_name || 'production-server' }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ–¹å¼**: ${{ github.event.inputs.deployment_method || 'docker' }}" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.DOMAIN_NAME }}" ]; then
            echo "- **åŸŸå**: https://${{ secrets.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **IP**: http://${{ secrets.SERVER_HOST }}:18789" >> $GITHUB_STEP_SUMMARY
          echo "- **å¥åº·æ£€æŸ¥**: http://${{ secrets.SERVER_HOST }}:18789/health" >> $GITHUB_STEP_SUMMARY

  notify-success:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Success notification
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æœåŠ¡å™¨: ${{ github.event.inputs.server_name || 'production-server' }}"
          echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:18789"

  notify-failure:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Failure notification
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"