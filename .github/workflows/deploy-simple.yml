name: Simple Deploy to Server

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'Server name'
        required: true
        default: 'production-server'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.23.0 --activate

      - name: Install and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Build Docker image
        run: |
          docker build -t moltbot:latest .

      - name: Save Docker image
        run: |
          docker save moltbot:latest | gzip > moltbot-image.tar.gz

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½² Moltbot"
            
            # åˆ›å»ºä¸´æ—¶ç›®å½•
            DEPLOY_DIR="/tmp/moltbot-deploy-$(date +%s)"
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # æ¥æ”¶é•œåƒæ–‡ä»¶ï¼ˆé€šè¿‡ scp ä¼ è¾“ï¼‰
            echo "ç­‰å¾…é•œåƒæ–‡ä»¶ä¼ è¾“..."

      - name: Transfer Docker image
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "moltbot-image.tar.gz"
          target: "/tmp/"

      - name: Load and run Docker image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ åŠ è½½å’Œè¿è¡Œ Docker é•œåƒ"
            
            cd /tmp
            
            # åŠ è½½é•œåƒ
            echo "åŠ è½½ Docker é•œåƒ..."
            docker load < moltbot-image.tar.gz
            
            # åœæ­¢ç°æœ‰å®¹å™¨
            echo "åœæ­¢ç°æœ‰å®¹å™¨..."
            docker stop moltbot || true
            docker rm moltbot || true
            
            # åˆ›å»ºæ•°æ®ç›®å½•
            echo "åˆ›å»ºæ•°æ®ç›®å½•..."
            mkdir -p ~/moltbot-data/.clawdbot
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo "å¯åŠ¨æ–°å®¹å™¨..."
            docker run -d \
              --name moltbot \
              --restart unless-stopped \
              -p 18789:18789 \
              -v ~/moltbot-data:/home/node/.clawdbot \
              -e NODE_ENV=production \
              -e CLAWDBOT_GATEWAY_TOKEN="${{ secrets.PRODUCTION_GATEWAY_TOKEN }}" \
              -e DEEPSEEK_API_KEY="${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}" \
              -e CLAWDBOT_VERSION="$(date +%Y%m%d-%H%M%S)" \
              moltbot:latest
            
            # ç­‰å¾…å¯åŠ¨
            echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
            sleep 15
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo "æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker ps | grep moltbot
            
            # æ£€æŸ¥æ—¥å¿—
            echo "å®¹å™¨æ—¥å¿—ï¼š"
            docker logs moltbot --tail 20
            
            # å¥åº·æ£€æŸ¥
            echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            for i in {1..10}; do
              if curl -f -m 5 http://localhost:18789/health; then
                echo "âœ… éƒ¨ç½²æˆåŠŸï¼å¥åº·æ£€æŸ¥é€šè¿‡"
                echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:18789"
                
                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -f /tmp/moltbot-image.tar.gz
                exit 0
              else
                echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/10..."
                sleep 3
              fi
            done
            
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            echo "å®¹å™¨è¯¦ç»†æ—¥å¿—ï¼š"
            docker logs moltbot
            exit 1

      - name: Deployment Summary
        if: success()
        run: |
          echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æœåŠ¡å™¨**: ${{ github.event.inputs.server_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è®¿é—®åœ°å€**: http://${{ secrets.SERVER_HOST }}:18789" >> $GITHUB_STEP_SUMMARY
          echo "**å¥åº·æ£€æŸ¥**: http://${{ secrets.SERVER_HOST }}:18789/health" >> $GITHUB_STEP_SUMMARY