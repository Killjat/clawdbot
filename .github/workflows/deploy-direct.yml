name: Direct Deploy (No Docker)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@10.23.0 --activate

      - name: Install and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Prepare deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…
          mkdir -p deploy-package
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r dist/ deploy-package/
          cp package.json deploy-package/
          cp pnpm-lock.yaml deploy-package/
          cp -r scripts/ deploy-package/
          
          # å¤åˆ¶é…ç½®æ¨¡æ¿
          cp config-template.json deploy-package/
          
          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > deploy-package/deploy.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸš€ å¼€å§‹éƒ¨ç½² Moltbot"
          
          # 1. å®‰è£… Node.js ä¾èµ–ï¼ˆä»…ç”Ÿäº§ä¾èµ–ï¼‰
          echo "å®‰è£…ä¾èµ–..."
          pnpm install --prod --frozen-lockfile
          
          # 2. ç”Ÿæˆé…ç½®æ–‡ä»¶
          echo "ç”Ÿæˆé…ç½®æ–‡ä»¶..."
          chmod +x scripts/generate-config.sh
          ./scripts/generate-config.sh
          
          # 3. åœæ­¢çŽ°æœ‰æœåŠ¡
          echo "åœæ­¢çŽ°æœ‰æœåŠ¡..."
          pkill -f "moltbot" || true
          
          # 4. å¯åŠ¨æ–°æœåŠ¡
          echo "å¯åŠ¨æœåŠ¡..."
          nohup node dist/index.js gateway run --bind lan --port 18789 > moltbot.log 2>&1 &
          
          # 5. ç­‰å¾…å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # 6. å¥åº·æ£€æŸ¥
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          for i in {1..5}; do
            if curl -f http://localhost:18789/health; then
              echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
              echo "æœåŠ¡å·²å¯åŠ¨ï¼ŒPID: $(pgrep -f 'node dist/index.js')"
              exit 0
            else
              echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $i/5..."
              sleep 5
            fi
          done
          
          echo "âŒ éƒ¨ç½²å¤±è´¥"
          echo "æŸ¥çœ‹æ—¥å¿—:"
          tail -20 moltbot.log
          exit 1
          EOF
          
          chmod +x deploy-package/deploy.sh
          
          # æ‰“åŒ…
          tar -czf moltbot-deploy.tar.gz -C deploy-package .

      - name: Upload to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          source: "moltbot-deploy.tar.gz"
          target: "/tmp/"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          envs: DEEPSEEK_API_KEY,GATEWAY_TOKEN,GATEWAY_HOST,GATEWAY_PORT,TLS_ENABLED,LOG_LEVEL
          script: |
            # è®¾ç½®çŽ¯å¢ƒå˜é‡
            export DEEPSEEK_API_KEY="${{ secrets.PRODUCTION_DEEPSEEK_API_KEY }}"
            export GATEWAY_TOKEN="${{ secrets.PRODUCTION_GATEWAY_TOKEN }}"
            export GATEWAY_HOST="0.0.0.0"
            export GATEWAY_PORT="18789"
            export TLS_ENABLED="true"
            export LOG_LEVEL="info"
            export NODE_ENV="production"
            
            # åˆ›å»ºåº”ç”¨ç›®å½•
            mkdir -p ~/moltbot-app
            cd ~/moltbot-app
            
            # è§£åŽ‹éƒ¨ç½²åŒ…
            tar -xzf /tmp/moltbot-deploy.tar.gz
            
            # å®‰è£… Node.js å’Œ pnpmï¼ˆå¦‚æžœæœªå®‰è£…ï¼‰
            if ! command -v node &> /dev/null; then
              echo "å®‰è£… Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_22.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            if ! command -v pnpm &> /dev/null; then
              echo "å®‰è£… pnpm..."
              corepack enable
              corepack prepare pnpm@10.23.0 --activate
            fi
            
            # æ‰§è¡Œéƒ¨ç½²
            ./deploy.sh
            
            # æ¸…ç†
            rm -f /tmp/moltbot-deploy.tar.gz

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "=== éƒ¨ç½²éªŒè¯ ==="
            
            # æ£€æŸ¥è¿›ç¨‹
            if pgrep -f "node dist/index.js" > /dev/null; then
              echo "âœ… Moltbot è¿›ç¨‹è¿è¡Œä¸­"
              echo "PID: $(pgrep -f 'node dist/index.js')"
            else
              echo "âŒ Moltbot è¿›ç¨‹æœªè¿è¡Œ"
              exit 1
            fi
            
            # æ£€æŸ¥ç«¯å£
            if netstat -tlnp | grep :18789 > /dev/null; then
              echo "âœ… ç«¯å£ 18789 å·²ç›‘å¬"
            else
              echo "âŒ ç«¯å£ 18789 æœªç›‘å¬"
              exit 1
            fi
            
            # å¥åº·æ£€æŸ¥
            if curl -f http://localhost:18789/health; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
            
            echo ""
            echo "ðŸŽ‰ éƒ¨ç½²éªŒè¯æˆåŠŸï¼"
            echo "è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}:18789"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**çŽ¯å¢ƒ**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**éƒ¨ç½²æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**è®¿é—®åœ°å€**: http://${{ secrets.SERVER_HOST }}:18789" >> $GITHUB_STEP_SUMMARY
          echo "**å¥åº·æ£€æŸ¥**: http://${{ secrets.SERVER_HOST }}:18789/health" >> $GITHUB_STEP_SUMMARY